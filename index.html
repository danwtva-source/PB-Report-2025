<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Communities' Choice - Final Integrated Report</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Arial+Nova:ital,wght@0,400;0,700;1,400&family=DynaPuff:wght@400;600;700&display=swap" rel="stylesheet">

    <style>
        /* --- Theme Variables --- */
        :root {
            --color-bg: #f8fafc;
            --color-text: #1e293b;
            --primary: #9333ea; /* Purple */
            --primary-dark: #7e22ce;
            --primary-light: #f3e8ff;
            --accent: #14b8a6; /* Teal */
            --accent-dark: #0f766e;
            --accent-light: #ccfbf1;
            --danger: #ef4444;
            --warning: #f59e0b;
            --success: #10b981;
            --glass: rgba(255, 255, 255, 0.75);
            --glass-border: rgba(255, 255, 255, 0.8);
            --shadow: 0 10px 30px -10px rgba(0, 0, 0, 0.1);
            --font-display: "DynaPuff", cursive;
            --font-sans: "Arial Nova", Arial, sans-serif;
        }

        body {
            font-family: var(--font-sans);
            background-color: #f0f4f8;
            background-image: 
                radial-gradient(at 0% 0%, rgba(147, 51, 234, 0.15) 0px, transparent 50%), 
                radial-gradient(at 100% 0%, rgba(20, 184, 166, 0.15) 0px, transparent 50%),
                radial-gradient(at 100% 100%, rgba(99, 102, 241, 0.1) 0px, transparent 50%);
            background-attachment: fixed;
            color: var(--color-text);
            margin: 0;
            height: 100vh;
            overflow: hidden;
        }

        /* Typography */
        h1, h2, h3, h4, .font-display { font-family: var(--font-display); }

        /* Layout */
        .app-container { display: flex; height: 100%; }
        
        /* Sidebar */
        .sidebar {
            width: 280px;
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(20px);
            border-right: 1px solid rgba(255,255,255,0.5);
            padding: 1.5rem;
            display: flex;
            flex-direction: column;
            z-index: 50;
            box-shadow: 5px 0 25px rgba(0,0,0,0.05);
        }

        /* Main Content */
        .main-content {
            flex: 1;
            overflow-y: auto;
            padding: 2rem;
            scroll-behavior: smooth;
        }

        /* Navigation */
        .nav-btn {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            margin-bottom: 8px;
            border-radius: 12px;
            color: #64748b;
            font-weight: 600;
            transition: all 0.3s ease;
            cursor: pointer;
            border: 1px solid transparent;
        }
        .nav-btn:hover { background: var(--primary-light); color: var(--primary); }
        .nav-btn.active {
            background: var(--primary);
            color: white;
            box-shadow: 0 4px 12px rgba(147, 51, 234, 0.3);
        }

        /* Cards */
        .glass-card {
            background: var(--glass);
            backdrop-filter: blur(16px);
            border: 1px solid var(--glass-border);
            border-radius: 20px;
            padding: 1.5rem;
            box-shadow: var(--shadow);
            transition: transform 0.2s ease;
        }
        .glass-card:hover { transform: translateY(-2px); }

        /* Status Badges */
        .badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        .badge-pass { background: #dcfce7; color: #166534; border: 1px solid #bbf7d0; }
        .badge-fail { background: #fee2e2; color: #991b1b; border: 1px solid #fecaca; }
        .badge-review { background: #fef3c7; color: #92400e; border: 1px solid #fde68a; }

        /* Metrics */
        .metric-label { font-size: 0.75rem; text-transform: uppercase; color: #64748b; font-weight: 700; letter-spacing: 0.05em; }
        .metric-value { font-size: 1.5rem; font-weight: 700; color: #1e293b; }
        
        /* Utilities */
        .text-gradient {
            background: linear-gradient(135deg, var(--primary), var(--accent));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .view-section { display: none; animation: fadeIn 0.4s ease-out; }
        .view-section.active { display: block; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: 0; } }
        
        /* Scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        @media (max-width: 768px) {
            .app-container { flex-direction: column; }
            .sidebar { width: 100%; height: auto; padding: 1rem; }
            .main-content { padding: 1rem; }
        }
    </style>
</head>
<body>

<div class="app-container">
    <!-- Sidebar -->
    <nav class="sidebar">
        <div class="mb-8 px-2">
            <!-- MODIFICATION: Replaced text header with responsive logo -->
            <img src="https://raw.githubusercontent.com/danwtva-source/PB-Report-2025/9adc3ea3418299ed31e584c8d8c7d88b07e37805/pb-english-transparent.png" alt="Communities' Choice Logo" class="w-full max-w-[200px] h-auto mx-auto" loading="lazy" width="200" height="60">

        <div class="flex-1 space-y-1">
            <div class="nav-btn active" onclick="router('dashboard', this)">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z"></path></svg>
                Executive Dashboard
            </div>
            
            <div class="mt-6 mb-2 px-4 text-xs font-bold text-gray-400 uppercase tracking-widest">Area Deep Dives</div>
            
            <!-- MODIFICATION: Updated area colors -->
            <div class="nav-btn" onclick="router('blaenavon', this)">
                <span class="w-2 h-2 rounded-full" style="background-color: #FFC000;"></span> Blaenavon (BLN)
            </div>
            <div class="nav-btn" onclick="router('thornhill', this)">
                <span class="w-2 h-2 rounded-full" style="background-color: #4EA72E;"></span> Thornhill (TUC)
            </div>
            <div class="nav-btn" onclick="router('trevethin', this)">
                <span class="w-2 h-2 rounded-full" style="background-color: #0070C0;"></span> Trevethin (TPS)
            </div>

            <div class="mt-6 mb-2 px-4 text-xs font-bold text-gray-400 uppercase tracking-widest">Analytics</div>
            
            <div class="nav-btn" onclick="router('financials', this)">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path></svg>
                Financial Intelligence
            </div>
            <div class="nav-btn" onclick="router('nextsteps', this)">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7l5 5m0 0l-5 5m5-5H6"></path></svg>
                Forward Plan 2026
            </div>
        </div>

        <div class="mt-auto pt-6 border-t border-gray-200">
            <div class="flex items-center gap-3 bg-white/50 p-3 rounded-xl">
                <div class="w-10 h-10 rounded-full bg-gradient-to-br from-primary to-accent flex items-center justify-center text-white font-bold text-sm">DW</div>
                <div>
                    <p class="text-sm font-bold text-gray-800">Dan Watkins</p>
                    <p class="text-xs text-gray-500">PB Coordinator</p>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="main-content">
        
        <!-- Header -->
        <div class="flex justify-between items-end mb-8">
            <div>
                <h2 class="text-4xl font-display font-bold text-gray-800" id="page-title">Executive Summary</h2>
                <p class="text-gray-500 mt-2 font-medium">Reporting Date: <span class="text-primary">10 Nov 2025</span></p>
            </div>
            <button onclick="window.print()" class="hidden md:block px-5 py-2.5 bg-white text-primary font-bold rounded-lg shadow-sm border border-primary hover:bg-purple-50 transition">
                Download PDF Report
            </button>
        </div>

        <!-- VIEW: DASHBOARD -->
        <div id="dashboard" class="view-section active">
            <!-- Top Stats -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                <div class="glass-card relative overflow-hidden">
                    <div class="absolute top-0 right-0 p-4 opacity-10"><svg class="w-16 h-16" fill="currentColor" viewBox="0 0 20 20"><path d="M4 4a2 2 0 00-2 2v4a2 2 0 002 2V6h10a2 2 0 00-2-2H4zm2 6a2 2 0 012-2h8a2 2 0 012 2v4a2 2 0 01-2 2H8a2 2 0 01-2-2v-4zm6 4a2 2 0 100-4 2 2 0 000 4z"></path></svg></div>
                    <p class="metric-label">Total Budget</p>
                    <p class="metric-value">£330,300</p>
                    <p class="text-xs text-gray-500 mt-2">Across 3 Communities</p>
                </div>
                <div class="glass-card relative overflow-hidden bg-gradient-to-br from-purple-600 to-purple-700 text-white">
                    <div class="absolute top-0 right-0 p-4 opacity-20"><svg class="w-16 h-16" fill="currentColor" viewBox="0 0 20 20"><path d="M2 11a1 1 0 011-1h2a1 1 0 011 1v5a1 1 0 01-1 1H3a1 1 0 01-1-1v-5zM8 7a1 1 0 011-1h2a1 1 0 011 1v9a1 1 0 01-1 1H9a1 1 0 01-1-1V7zM14 4a1 1 0 011-1h2a1 1 0 011 1v12a1 1 0 01-1 1h-2a1 1 0 01-1-1V4z"></path></svg></div>
                    <p class="text-purple-100 text-xs font-bold uppercase tracking-wider">Total Votes Cast</p>
                    <p class="text-4xl font-bold mt-1">2,159</p>
                    <div class="flex gap-3 mt-4">
                        <span class="text-xs bg-white/20 px-2 py-1 rounded">Digital: 81%</span>
                        <span class="text-xs bg-white/20 px-2 py-1 rounded">In-Person: 19%</span>
                    </div>
                </div>
                <div class="glass-card relative overflow-hidden">
                    <p class="metric-label">Funds Allocated</p>
                    <p class="metric-value text-primary">£111,262</p>
                    <div class="w-full bg-gray-100 rounded-full h-1.5 mt-3">
                        <div class="bg-primary h-1.5 rounded-full" style="width: 33.7%"></div>
                    </div>
                    <p class="text-xs text-gray-500 mt-2">33.7% Utilization</p>
                </div>
                <div class="glass-card relative overflow-hidden">
                    <p class="metric-label">Project Status</p>
                    <div class="flex items-baseline gap-1">
                        <p class="metric-value">20</p>
                        <span class="text-sm text-gray-400">Finalists</span>
                    </div>
                    <div class="flex gap-2 mt-3">
                        <div class="text-center">
                            <div class="w-2 h-2 bg-green-500 rounded-full mx-auto mb-1"></div>
                            <span class="text-xs font-bold text-gray-600">16 Pass</span>
                        </div>
                        <div class="text-center">
                            <div class="w-2 h-2 bg-yellow-500 rounded-full mx-auto mb-1"></div>
                            <span class="text-xs font-bold text-gray-600">2 Review</span>
                        </div>
                        <div class="text-center">
                            <div class="w-2 h-2 bg-red-500 rounded-full mx-auto mb-1"></div>
                            <span class="text-xs font-bold text-gray-600">2 Fail</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Narrative & Chart -->
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                <div class="col-span-2 glass-card">
                    <h3 class="text-xl font-bold text-gray-800 mb-4 border-l-4 border-primary pl-3">Strategic Overview</h3>
                    <div class="prose text-gray-600">
                        <p class="mb-4">The 2025 "Communities' Choice" initiative has successfully empowered residents across Blaenavon, Thornhill & Upper Cwmbran, and Trevethin, Penygarn & St. Cadocs to allocate public funds directly. The voting response was robust, with a significant shift towards digital engagement (81%).</p>
                        <p class="mb-4">Recommendations are strictly data-informed, utilising a <strong class="text-primary">10% vote threshold</strong>. Projects falling below this line are not recommended for funding, ensuring community consensus drives investment.</p>
                        <!-- MODIFICATION: Removed Blaenavon 24-hour warning note -->
                    </div>
                </div>
                
                <div class="glass-card flex flex-col justify-between">
                    <div>
                        <h3 class="text-lg font-bold text-gray-800 mb-2">Vote Distribution</h3>
                        <p class="text-xs text-gray-400 mb-4">Votes cast per area</p>
                    </div>
                    <div class="h-48">
                        <canvas id="chart-overview-doughnut"></canvas>
                    </div>
                    <!-- MODIFICATION: Updated legend colors -->
                    <div class="mt-4 grid grid-cols-3 text-center text-xs">
                        <div><span class="block font-bold" style="color: #FFC000;">1,349</span>BLN</div>
                        <div><span class="block font-bold" style="color: #4EA72E;">113</span>TUC</div>
                        <div><span class="block font-bold" style="color: #0070C0;">697</span>TPS</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- VIEW: AREA (Reusable Template) -->
        <div id="area-view-container" class="view-section">
            <!-- Injected via JS -->
        </div>

        <!-- VIEW: FINANCIAL INTELLIGENCE -->
        <div id="financials" class="view-section">
            <h3 class="text-2xl font-bold text-gray-800 mb-6 flex items-center gap-3">
                <span class="p-2 bg-green-100 text-green-600 rounded-lg font-bold">£</span>
                Financial Intelligence
            </h3>

            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 mb-8">
                <!-- Budget Table -->
                <div class="glass-card col-span-2 overflow-hidden">
                    <h4 class="font-bold text-gray-700 mb-4">Budget Utilisation Summary</h4>
                    <table class="w-full text-left text-sm">
                        <thead class="bg-gray-50 text-gray-500 uppercase text-xs">
                            <tr>
                                <th class="p-3 rounded-tl-lg">Area</th>
                                <th class="p-3 text-right">Available</th>
                                <th class="p-3 text-right">Allocated</th>
                                <th class="p-3 text-right">Remaining</th>
                                <th class="p-3 text-right rounded-tr-lg">% Used</th>
                            </tr>
                        </thead>
                        <tbody id="financial-tbody"></tbody>
                    </table>
                </div>

                <!-- Insight Card -->
                <div class="glass-card bg-gradient-to-br from-gray-800 to-gray-900 text-white">
                    <h4 class="font-bold text-gray-200 mb-4">Key Insights</h4>
                    <ul class="space-y-4 text-sm text-gray-300">
                        <li class="flex gap-3">
                            <span class="text-green-400 font-bold text-lg">£219k</span>
                            <span>Remains available for a potential 2026 funding round.</span>
                        </li>
                        <li class="flex gap-3">
                            <span class="text-purple-400 font-bold text-lg">TPS</span>
                            <span>Has the largest reserve (£132k), suggesting scope for larger capital projects next year.</span>
                        </li>
                        <li class="flex gap-3">
                            <span class="text-teal-400 font-bold text-lg">£2.33</span>
                            <span>Lowest Cost Per Vote (Torfaen Youth), indicating high community reach for low investment.</span>
                        </li>
                    </ul>
                </div>
            </div>

            <!-- Cost Efficiency Chart -->
            <div class="glass-card">
                <h4 class="font-bold text-gray-700 mb-2">Cost Efficiency Analysis (Cost Per Vote)</h4>
                <p class="text-xs text-gray-400 mb-4">Lower is better efficiency. High bars indicate expensive engagement.</p>
                <div class="h-64">
                    <canvas id="chart-cpv"></canvas>
                </div>
            </div>
        </div>

        <!-- VIEW: NEXT STEPS -->
        <div id="nextsteps" class="view-section">
            <h3 class="text-2xl font-bold text-gray-800 mb-6">Forward Plan 2026</h3>
            
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                <!-- BLN -->
                <div class="glass-card border-t-4 border-purple-500">
                    <h4 class="text-lg font-bold text-gray-800 mb-2">Blaenavon</h4>
                    <div class="flex items-center gap-2 mb-3">
                        <span class="text-xs font-bold bg-purple-100 text-purple-700 px-2 py-1 rounded">Transport</span>
                        <span class="text-xs font-bold bg-purple-100 text-purple-700 px-2 py-1 rounded">Environment</span>
                    </div>
                    <p class="text-sm text-gray-600">Explore integration with the Blaenavon Transport scheme to utilise PB funds for transport enhancements.</p>
                </div>
                
                <!-- TUC -->
                <div class="glass-card border-t-4 border-teal-500">
                    <h4 class="text-lg font-bold text-gray-800 mb-2">Thornhill</h4>
                    <div class="flex items-center gap-2 mb-3">
                        <span class="text-xs font-bold bg-teal-100 text-teal-700 px-2 py-1 rounded">Skills</span>
                        <span class="text-xs font-bold bg-teal-100 text-teal-700 px-2 py-1 rounded">ASB</span>
                    </div>
                    <p class="text-sm text-gray-600">Target organisations supporting skills in top 20 future career areas. Encourage entrepreneurship initiatives.</p>
                </div>

                <!-- TPS -->
                <div class="glass-card border-t-4 border-indigo-500">
                    <h4 class="text-lg font-bold text-gray-800 mb-2">Trevethin</h4>
                    <div class="flex items-center gap-2 mb-3">
                        <span class="text-xs font-bold bg-indigo-100 text-indigo-700 px-2 py-1 rounded">Mental Health</span>
                        <span class="text-xs font-bold bg-indigo-100 text-indigo-700 px-2 py-1 rounded">Elderly</span>
                    </div>
                    <p class="text-sm text-gray-600">Host mental health focus groups. Engage social clubs to identify gaps for older residents.</p>
                </div>
            </div>

            <div class="glass-card bg-red-50 border border-red-100 p-6">
                <h4 class="text-lg font-bold text-red-800 mb-4 flex items-center gap-2">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path></svg>
                    Immediate Committee Actions Required
                </h4>
                <div class="space-y-4">
                    <div class="flex gap-4">
                        <div class="min-w-[80px] text-xs font-bold bg-red-200 text-red-800 py-1 px-2 rounded text-center h-fit">VOTE</div>
                        <div>
                            <p class="font-bold text-red-900">Tidy Butt (TPS)</p>
                            <p class="text-sm text-red-800">Project met vote threshold but failed to confirm delivery capacity during due diligence.</p>
                        </div>
                    </div>
                    <div class="flex gap-4">
                        <div class="min-w-[80px] text-xs font-bold bg-yellow-200 text-yellow-800 py-1 px-2 rounded text-center h-fit">REVIEW</div>
                        <div>
                            <p class="font-bold text-yellow-900">Torfaen Talks (TUC)</p>
                            <p class="text-sm text-yellow-800">Received 11 votes. Threshold is 11.3 votes (10%). Technically fails, requires committee discretion.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </main>
</div>

<script>
    // --- CENTRAL DATA STORE ---
    // Merged from PDF and CSV data sources
    const DB = {
        areas: {
            BLN: {
                name: "Blaenavon",
                color: "#FFC000", // MODIFICATION: Updated area color
                stats: { budget: 73450, votes: 1349, threshold: 135 },
                topPriorities: ["Youth Services", "Transport", "Antisocial Behaviour", "Health", "Environment", "Heritage"],
                projects: [
                    { name: "Mini & Juniors RFC", cost: 4044, votes: 378, digital: 285, inperson: 93, status: "Pass", priorities: ["Youth Services", "Health"], cpv: 10.70 },
                    { name: "Blaenavon Blues AFC", cost: 9960, votes: 247, digital: 222, inperson: 25, status: "Pass", priorities: ["Environment", "Health"], cpv: 40.32 },
                    { name: "Torfaen Youth Service", cost: 540, votes: 231, digital: 219, inperson: 12, status: "Pass", priorities: ["Youth Services", "Heritage"], cpv: 2.34 },
                    { name: "Horticultural Project", cost: 2086, votes: 225, digital: 206, inperson: 19, status: "Pass", priorities: ["Education", "Youth Services"], cpv: 9.27 },
                    { name: "Blaenavon Town Band", cost: 7950, votes: 161, digital: 107, inperson: 54, status: "Pass", priorities: ["Health", "Youth Services"], cpv: 49.38 },
                    { name: "Welsh Language Group", cost: 950, votes: 107, digital: 91, inperson: 16, status: "Fail", priorities: ["Heritage", "Education"], cpv: 8.88 }
                ]
            },
            TUC: {
                name: "Thornhill & Upper Cwmbran",
                color: "#4EA72E", // MODIFICATION: Updated area color
                stats: { budget: 81850, votes: 113, threshold: 12 }, // 10% of 113 = 11.3 -> 12
                topPriorities: ["Health", "Youth Services", "Sustainability", "Community Building", "ASB", "Education"],
                projects: [
                    { name: "Thornhill Comm Centre", cost: 10000, votes: 23, digital: 17, inperson: 6, status: "Pass", priorities: ["Community Building", "Youth Services"], cpv: 434.78 },
                    { name: "BlaenBran Woodland", cost: 974, votes: 20, digital: 14, inperson: 6, status: "Pass", priorities: ["Education", "Sustainability"], cpv: 48.70 },
                    { name: "Panik Art", cost: 9548, votes: 16, digital: 9, inperson: 7, status: "Pass", priorities: ["Education", "Youth Services"], cpv: 596.75 },
                    { name: "Able My Life", cost: 7800, votes: 15, digital: 15, inperson: 0, status: "Pass", priorities: ["Health", "Community Building"], cpv: 520.00 },
                    { name: "HIPHOP12", cost: 9876, votes: 14, digital: 8, inperson: 6, status: "Pass", priorities: ["Youth Services", "Health"], cpv: 705.43 },
                    { name: "Pontnewydd Choir", cost: 1590, votes: 14, digital: 8, inperson: 6, status: "Pass", priorities: ["Health", "Youth Services"], cpv: 113.57 },
                    { name: "Torfaen Talks CIC", cost: 3300, votes: 11, digital: 10, inperson: 1, status: "Review", priorities: ["Health"], cpv: 300.00 }
                ]
            },
            TPS: {
                name: "Trevethin & Penygarn",
                color: "#0070C0", // MODIFICATION: Updated area color
                stats: { budget: 175000, votes: 697, threshold: 70 },
                topPriorities: ["Environment", "Youth Services", "Health", "Older People", "Crime Safety", "Education"],
                projects: [
                    { name: "Penygarn Trevethin FC", cost: 10009, votes: 189, digital: 115, inperson: 74, status: "Pass", priorities: ["Youth Services", "Health"], cpv: 52.96 },
                    { name: "Trevethin Comm Centre", cost: 10000, votes: 135, digital: 102, inperson: 33, status: "Pass", priorities: ["Environment", "Older People"], cpv: 74.07 },
                    { name: "MentROAR", cost: 3300, votes: 95, digital: 66, inperson: 29, status: "Pass", priorities: ["Health", "Youth Services"], cpv: 34.74 },
                    { name: "Torfaen Young Parents", cost: 2775, votes: 83, digital: 64, inperson: 19, status: "Pass", priorities: ["Youth Services", "Education"], cpv: 33.43 },
                    { name: "Abersychan School", cost: 3300, votes: 72, digital: 67, inperson: 5, status: "Pass", priorities: ["Youth Services", "Education"], cpv: 45.83 },
                    { name: "Tidy Butt", cost: 9960, votes: 70, digital: 66, inperson: 4, status: "Review", priorities: ["Health"], cpv: 142.29 },
                    { name: "Torfaen Talks CIC", cost: 3300, votes: 53, digital: 48, inperson: 5, status: "Fail", priorities: ["Health"], cpv: 62.26 }
                ]
            }
        }
    };

    // --- ROUTING & NAVIGATION ---
    function router(viewId, navEl) {
        // 1. UI State
        document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active'));
        document.querySelectorAll('.nav-btn').forEach(el => el.classList.remove('active'));
        
        // 2. Activate View
        const isArea = ['blaenavon', 'thornhill', 'trevethin'].includes(viewId);
        if(isArea) {
            renderAreaView(viewId);
            document.getElementById('area-view-container').classList.add('active');
        } else {
            document.getElementById(viewId).classList.add('active');
        }

        // 3. Activate Nav
        if(navEl) navEl.classList.add('active');
        
        // 4. Update Title
        const titles = {
            dashboard: 'Executive Summary',
            financials: 'Financial Intelligence',
            nextsteps: 'Forward Plan 2026'
        };
        if(!isArea) document.getElementById('page-title').innerText = titles[viewId];
    }

    // --- RENDER: AREA DEEP DIVE ---
    function renderAreaView(areaKey) {
        const code = areaKey === 'blaenavon' ? 'BLN' : (areaKey === 'thornhill' ? 'TUC' : 'TPS');
        const area = DB.areas[code];
        const container = document.getElementById('area-view-container');

        // 1. Header
        let html = `
            <div class="flex justify-between items-start mb-6 animate-fade-in">
                <div>
                    <h2 class="text-3xl font-bold" style="color: ${area.color}">${area.name}</h2>
                    <p class="text-gray-500">Area Deep Dive</p>
                </div>
                <div class="text-right">
                    <p class="text-xs font-bold text-gray-400 uppercase">Threshold</p>
                    <p class="text-2xl font-bold text-gray-700">${area.stats.threshold} <span class="text-sm font-normal text-gray-400">Votes</span></p>
                </div>
            </div>
            
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
                <!-- Chart: Votes + Threshold -->
                <div class="glass-card">
                    <h4 class="font-bold text-gray-700 mb-4">Vote Performance vs Threshold</h4>
                    <div class="h-64"><canvas id="chart-votes-${code}"></canvas></div>
                </div>
                
                <!-- Chart: Strategic Alignment -->
                <div class="glass-card">
                    <h4 class="font-bold text-gray-700 mb-4">Priority Alignment</h4>
                    <p class="text-xs text-gray-400 mb-2">Funded projects vs Area Priorities</p>
                    <div class="h-64"><canvas id="chart-align-${code}"></canvas></div>
                </div>
            </div>

            <!-- Project Ledger -->
            <h3 class="text-xl font-bold text-gray-800 mb-4">Project Ledger</h3>
            <div class="grid grid-cols-1 gap-3">
        `;

        // 2. Project List
        area.projects.forEach(p => {
            const badge = p.status === 'Pass' ? 'badge-pass' : (p.status === 'Review' ? 'badge-review' : 'badge-fail');
            html += `
                <div class="glass-card p-4 flex flex-col md:flex-row items-center justify-between gap-4 hover:bg-white/40 transition">
                    <div class="flex-1">
                        <div class="flex items-center gap-3 mb-1">
                            <span class="badge ${badge}">${p.status === 'Pass' ? 'Recommended' : p.status}</span>
                            <h4 class="font-bold text-gray-800">${p.name}</h4>
                        </div>
                        <div class="flex gap-2">
                            ${p.priorities.map(pr => `<span class="text-xs bg-gray-100 text-gray-500 px-2 py-0.5 rounded border border-gray-200">${pr}</span>`).join('')}
                        </div>
                    </div>
                    
                    <div class="flex items-center gap-8 text-right">
                        <div>
                            <p class="text-[10px] font-bold text-gray-400 uppercase tracking-wider">Cost / Vote</p>
                            <p class="font-mono text-sm text-gray-600">£${p.cpv.toFixed(2)}</p>
                        </div>
                        <div>
                            <p class="text-[10px] font-bold text-gray-400 uppercase tracking-wider">Total Votes</p>
                            <div class="flex items-baseline justify-end gap-1">
                                <p class="text-xl font-bold text-gray-800">${p.votes}</p>
                                <span class="text-xs text-gray-400">(${Math.round((p.votes/area.stats.votes)*100)}%)</span>
                            </div>
                            <div class="w-24 h-1.5 flex rounded-full overflow-hidden mt-1 ml-auto">
                                <div class="bg-purple-500" style="width: ${(p.digital/p.votes)*100}%"></div>
                                <div class="bg-teal-500" style="width: ${(p.inperson/p.votes)*100}%"></div>
                            </div>
                        </div>
                        <div class="min-w-[80px]">
                             <p class="text-[10px] font-bold text-gray-400 uppercase tracking-wider">Value</p>
                             <p class="font-bold text-gray-800">£${p.cost.toLocaleString()}</p>
                        </div>
                    </div>
                </div>
            `;
        });
        html += `</div>`;
        
        container.innerHTML = html;

        // 3. Init Charts
        setTimeout(() => {
            initAreaCharts(code, area);
        }, 50);
    }

    // --- CHARTS LOGIC ---
    function initAreaCharts(code, area) {
        // Vote Chart (Stacked Bar for Digital/InPerson)
        new Chart(document.getElementById(`chart-votes-${code}`), {
            type: 'bar',
            data: {
                labels: area.projects.map(p => p.name.substring(0, 10) + '...'),
                datasets: [
                    { label: 'Digital', data: area.projects.map(p => p.digital), backgroundColor: '#9333ea' },
                    { label: 'In-Person', data: area.projects.map(p => p.inperson), backgroundColor: '#14b8a6' }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: { x: { stacked: true }, y: { stacked: true, beginAtZero: true } },
                plugins: {
                    annotation: {
                        annotations: {
                            line1: {
                                type: 'line',
                                yMin: area.stats.threshold,
                                yMax: area.stats.threshold,
                                borderColor: '#ef4444',
                                borderWidth: 2,
                                borderDash: [5, 5],
                                label: { content: '10% Pass', enabled: true, color: '#ef4444' }
                            }
                        }
                    }
                }
            }
        });

        // Alignment Chart
        const priorityCounts = area.topPriorities.map(prio => 
            area.projects.filter(p => p.status === 'Pass' && p.priorities.some(pp => pp.includes(prio.split(' ')[0]))).length
        );
        
        new Chart(document.getElementById(`chart-align-${code}`), {
            type: 'bar',
            data: {
                labels: area.topPriorities,
                datasets: [{ label: 'Funded Projects', data: priorityCounts, backgroundColor: area.color, borderRadius: 4 }]
            },
            options: {
                indexAxis: 'y',
                responsive: true,
                maintainAspectRatio: false,
                scales: { x: { beginAtZero: true, ticks: { stepSize: 1 } } }
            }
        });
    }

    function initDashboardCharts() {
        // Overview Doughnut
        new Chart(document.getElementById('chart-overview-doughnut'), {
            type: 'doughnut',
            data: {
                labels: ['Blaenavon', 'Thornhill', 'Trevethin'],
                datasets: [{
                    data: [1349, 113, 697],
                    backgroundColor: ['#FFC000', '#4EA72E', '#0070C0'], // MODIFICATION: Updated area colors
                    borderWidth: 0
                }]
            },
            options: { cutout: '75%', plugins: { legend: { display: false } } }
        });
    }

    function initFinancialCharts() {
        // Render Table
        let tableHtml = '';
        let totalAlloc = 0;
        
        Object.values(DB.areas).forEach(area => {
            const alloc = area.projects.filter(p => p.status === 'Pass').reduce((a, b) => a + b.cost, 0);
            totalAlloc += alloc;
            const remain = area.stats.budget - alloc;
            const pct = ((alloc / area.stats.budget)*100).toFixed(1);
            
            tableHtml += `
                <tr class="border-b border-gray-100 hover:bg-gray-50">
                    <td class="p-3 font-bold text-gray-700">${area.name}</td>
                    <td class="p-3 text-right">£${area.stats.budget.toLocaleString()}</td>
                    <td class="p-3 text-right font-bold text-primary">£${alloc.toLocaleString()}</td>
                    <td class="p-3 text-right text-green-600 font-bold">£${remain.toLocaleString()}</td>
                    <td class="p-3 text-right text-gray-500">${pct}%</td>
                </tr>
            `;
        });
        document.getElementById('financial-tbody').innerHTML = tableHtml;

        // Cost Efficiency Chart
        // Gather all Pass projects sorted by CPV
        const allProjects = [
            ...DB.areas.BLN.projects,
            ...DB.areas.TUC.projects,
            ...DB.areas.TPS.projects
        ].filter(p => p.status === 'Pass').sort((a,b) => a.cpv - b.cpv);

        // Take top 5 and bottom 5 for comparison to keep chart readable
        const chartProjects = [...allProjects.slice(0, 5), ...allProjects.slice(-5)];

        new Chart(document.getElementById('chart-cpv'), {
            type: 'bar',
            data: {
                labels: chartProjects.map(p => p.name),
                datasets: [{
                    label: 'Cost Per Vote (£)',
                    data: chartProjects.map(p => p.cpv),
                    backgroundColor: chartProjects.map(p => p.cpv < 50 ? '#10b981' : '#f59e0b'),
                    borderRadius: 4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: { y: { beginAtZero: true, title: { display: true, text: 'Cost per Vote (£)' } } }
            }
        });
    }

    // --- INIT ---
    window.onload = () => {
        Chart.defaults.font.family = "'Arial Nova', sans-serif";
        initDashboardCharts();
        initFinancialCharts();
    };

</script>
</body>

</html>




